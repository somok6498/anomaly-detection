services:
  aerospike:
    image: aerospike/aerospike-server:7.1.0.2
    container_name: aerospike-anomaly
    ports:
      - "3000:3000"   # client port
      - "3001:3001"   # fabric port
      - "3002:3002"   # mesh heartbeat port
      - "3003:3003"   # info port
    volumes:
      - ./aerospike/aerospike.conf:/opt/aerospike/etc/aerospike.conf
      - aerospike-data:/opt/aerospike/data
    command: ["--config-file", "/opt/aerospike/etc/aerospike.conf"]
    healthcheck:
      test: ["CMD", "asinfo", "-p", "3000", "-v", "status"]
      interval: 5s
      timeout: 3s
      retries: 10

  jaeger:
    image: jaegertracing/all-in-one:1.54
    container_name: jaeger
    ports:
      - "16686:16686"   # Jaeger UI
      - "4317:4317"     # OTLP gRPC receiver
      - "4318:4318"     # OTLP HTTP receiver
    environment:
      COLLECTOR_OTLP_ENABLED: "true"

  app:
    build: .
    container_name: anomaly-detection-app
    ports:
      - "8080:8080"
    environment:
      - AEROSPIKE_HOST=aerospike
      - AEROSPIKE_PORT=3000
      - MANAGEMENT_OTLP_TRACING_ENDPOINT=http://jaeger:4318/v1/traces
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID:-}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN:-}
      - TWILIO_FROM_NUMBER=${TWILIO_FROM_NUMBER:-+14155238886}
      - TWILIO_TO_NUMBER=${TWILIO_TO_NUMBER:-+919830709527}
      - TWILIO_ENABLED=${TWILIO_ENABLED:-true}
      - TWILIO_CHANNEL=${TWILIO_CHANNEL:-whatsapp}
      # Set SPRING_PROFILES_ACTIVE=seed for first run to load demo data
    depends_on:
      aerospike:
        condition: service_healthy
      jaeger:
        condition: service_started
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:v2.50.1
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    depends_on:
      app:
        condition: service_started

  grafana:
    image: grafana/grafana:10.3.3
    container_name: grafana
    ports:
      - "3333:3000"   # 3333 to avoid conflict with Aerospike port 3000
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Viewer
    depends_on:
      prometheus:
        condition: service_started

  # All-in-one: single container with Aerospike + App + auto-seeding
  allinone:
    build:
      context: .
      dockerfile: Dockerfile.allinone
    container_name: anomaly-detection
    ports:
      - "8080:8080"
      - "3000:3000"
    restart: unless-stopped

volumes:
  aerospike-data:
